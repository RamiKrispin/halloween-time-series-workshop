---
title: "Decomposition of Time Series"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.height=5, fig.width=8,
                      message=FALSE, warning=FALSE)
```

Generally, we can categorize patterns in time series data into the following two categories:
 
* **Structural patterns -** also known as the series components. There are three main components:
    * trend - the series growth overtime
    * cycle - repeated events over time that are not equally spaced
    * seasonal - repeated events over time that are equally spaced
* **Non-structural patterns -** also known as the irregular components, which is basically any pattern on the series that is not represented by the structural patterns. An example of such a pattern could be repeated events that are not seasonal (e.g., Easter or the Chinese New Year are both occurred every year, but the date is changing from year to year)

Those patterns are either exists or not (e.g., a series may have a trend or not). We can express those components using the following notation for additive structure:

$$Y_t=T_t + C_t + S_t + I_t, $$

And for multiplicative structure:

$$Y_t=T_t \times C_t \times S_t \times I_t $$


For simplicity reasons, we will joined the cycle component into the trend, and rewrite the series components notation for additive structure:

$$Y_t=T_t + S_t + I_t, $$ 
And for multiplicative structure:

$$Y_t=T_t \times S_t \times I_t $$


In this section, we will focus on decomposition methods of time series to its components - the trend, seasonal, and irregular.

### Classical Decomposition

The classical decomposition (or by its full name - classical seasonal decomposition by moving average) is one of the most commom estimation method of the series components. R provides a built-in method for decompose time series with the `decompose` function from the **stats** package:

```{r}
data("AirPassengers")

d <- decompose(AirPassengers)

str(d)
```


```{r}
plot(d)
```


```{r}
d_m <- decompose(AirPassengers, type = "multiplicative")

plot(d_m)
```


```{r }
library(TSstudio)

ts_decompose(AirPassengers, type = "both")
```


```{r}
library(tsibble)
library(feasts)
library(fabletools)

ap_tsibble <- as_tsibble(AirPassengers)

decompose_md <- ap_tsibble %>% 
  model(classical_decomposition(value, type = "multiplicative"))


```



```{r}
decompose_md %>% 
  components() %>% 
  head()


decompose_md %>% 
  components() %>%
  autoplot()
```
```{r}
d_tsibble <- decompose_md$`classical_decomposition(value, type = "multiplicative")`[[1]]$fit$decomposition
```

### STL Decomposition

WIP